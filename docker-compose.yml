worker: &worker
  build: ./
  command: supervisord -n -c /app/docker/supervisor-celery.conf
  volumes:
    - ./:/app
  links:
    - memcached
    - postgres
    - elasticsearch
    - redis
  environment:
    # Django settings overrides:
    - DEBUG=true
    - PROTOCOL=http://
    # - DOMAIN=developer-local.allizom.org
    - DOMAIN=kuma.dev  # FIXME
    - DATABASE_URL=postgres://kuma:kuma@postgres/kuma
    - MEMCACHE_SERVERS=memcached:11211
    # - ALLOWED_HOSTS=developer-local.allizom.org
    - ALLOWED_HOSTS=kuma.dev  # FIXME
    - BROKER_URL=redis://redis:6379/0
    - CELERY_ALWAYS_EAGER=false
    - ES_URLS=elasticsearch:9200
    # Other environment variables:
    - PYTHONDONTWRITEBYTECODE=1

# Web is based on worker b/c you cannot clear the "ports" with docker-compose.
web:
  <<: *worker
  command: supervisord -n -c /app/docker/supervisor.conf
  ports:
    - "8000:8000"

nginx:
  build: ./docker/images/nginx
  volumes:
    - ./static:/app/static
  ports:
    - "80:80"
  links:
    - web

memcached:
  image: memcached

db-data:
  build: ./images/db-data
  volumes:
    - /var/lib/postgresql

postgres:
  image: postgres:9.4
  environment:
    - POSTGRES_USER=kuma
    - POSTGRES_PASSWORD=kuma
    - POSTGRES_DB=kuma
  volumes_from:
    - db-data
  ports:
    - "5432:5432"

elasticsearch:
  image: elasticsearch:1.7

redis:
  image: redis
