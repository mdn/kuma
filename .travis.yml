sudo: required
branches:
    only:
        - master
language: python
python:
    - "2.7"
services:
    - docker
env:
    global:
        - DOCKER_COMPOSE_VERSION=1.23.2
        - UID=0
install:
    - scripts/travis-install
script:
    - set -e
    - VERSION=latest make build-base
    - VERSION=latest make build-kuma
    - docker-compose --version
    - docker-compose down --volumes --remove-orphans
    - docker-compose pull mysql redis elasticsearch kumascript
    - docker-compose up -d
    - docker-compose exec -T web urlwait mysql://root:kuma@mysql:3306/developer_mozilla_org 300
    - docker-compose exec -T web make clean localecompile build-static
    - docker-compose exec -T web ./manage.py migrate
    - docker-compose exec -T web make lint
    - docker-compose exec -T web make test
    - docker-compose down --volumes --remove-orphans
after_failure:
    - dmesg | tail
notifications:
    irc:
        channels:
            - "irc.mozilla.org#mdndev"
        on_success: always
        on_failure: always
        use_notice: true
