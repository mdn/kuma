language: python
cache: apt

python:
    - "2.6"

env:
  global:
      - FORCE_DB=1
      - PYTHONPATH=.
      - DJANGO_SETTINGS_MODULE=settings_travis
      - DEBIAN_FRONTEND=noninteractive
      - secure: "BDhiGi2cADI8YC3vcaDW94k1fOb1GmyoANPu1a3T9qPsMDRhpcFAV4zsmu3gMFerv8YYq1Otl0Uq76PyAHXyHKIx3U+VomYXlG2Pb40X/tBseXlPnNbgdvzclf7fWJH9hzxlYSgSaKE5hVn0Gu3sNJM0ZGCdlzg9DMxKqE6xXvs="
      - secure: "GPCURF5Ww3fvzR8pPK+C8yTgYry/BP9VD6y+4vWUHfxO0a8WlP0+WJqSo+16nPt4+7jf48Y06Q5xLjuUi1Y8ksT4Q/CVNYf42XWFBfRNK1YWz5Ze0ebPN7lEOF5CXxPzPw+h/eK72aq9sRYxJ/7n8DfdCGFR82ms6qG8+vbVADI=â€œ

services:
    - memcached

before_install:
    - sudo apt-get update -qq
    - sudo apt-get -y install build-essential aria2 libxml2-dev libxslt-dev libjpeg8 libjpeg62-dev libfreetype6 libfreetype6-dev zlib1g-dev sqlite3 libtidy-dev
    - sudo ln -s /usr/lib/`uname -i`-linux-gnu/libfreetype.so /usr/lib
    - sudo ln -s /usr/lib/`uname -i`-linux-gnu/libz.so /usr/lib
    - aria2c -j 10 https://s3-us-west-2.amazonaws.com/pkgs.mozilla.net/python/mdn/travis_wheels.tar.gz
    - aria2c -j 10 https://s3-us-west-2.amazonaws.com/pkgs.mozilla.net/python/mdn/product_details_json.tar.gz
    - aria2c -j 10 https://s3-us-west-2.amazonaws.com/pkgs.mozilla.net/locale/mdn/locale.tar.gz
    - tar xvfz travis_wheels.tar.gz
    - tar -C .. -zxf product_details_json.tar.gz
    - tar xvfz locale.tar.gz
    - wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-0.90.13.deb
    - sudo dpkg --force-confdef -i elasticsearch-0.90.13.deb
    - sudo service elasticsearch start

install:
    # we install 1.4.x here separately because 1.4.x can't be packaged as a wheel file
    - pip install -U pip wheel Django==1.4.13
    - pip install --find-links=travis_wheels -r requirements/compiled.txt
    - pip install coveralls
    # JS test requirements
    - curl -sL https://deb.nodesource.com/setup | sudo bash -
    - sudo apt-get install -y nodejs

before_script:
    - mysql -e 'create database kuma;'

script:
    - coverage run --include=`pwd`/kuma/*,`pwd`/apps/* manage.py test --noinput -v2 access actioncounters authkeys contentflagging devmo kpi kuma landing sumo
    - cd tests/ui
    - npm install intern
    - node_modules/.bin/intern-runner config=intern-sauce-labs d=developer.allizom.org

after_success:
    - coveralls

notifications:
    irc:
        channels:
            - "irc.mozilla.org#mdndev"
        on_success: always
        on_failure: always
        use_notice: true
