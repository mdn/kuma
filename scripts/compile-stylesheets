#!/bin/bash

# The Sass executable resides in /usr/local/bin on our public servers. For
# this script to work correctly on those servers, we need to include the
# directory in our PATH.
#
# See: https://bugzilla.mozilla.org/show_bug.cgi?id=1092364
PATH=/usr/local/bin:$PATH

BASEDIR=$(dirname $0)
CSSDIR=$BASEDIR/../build/assets/css
SASSDIR=$BASEDIR/../kuma/static/styles

for opt in "$@"; do
  case $opt in
    --watch|-w) WATCH=true;;
    --quiet|-q) QUIET=true;;
  esac
done

if [ ! -d "$CSSDIR" ]; then
  mkdir -p $CSSDIR
fi

STYLESHEETS=($SASSDIR/*.scss)
if [ $WATCH ]; then
  echo Watching and automatically compiling stylesheets

  # Using $STYLESHEETS directly so that sass only watches each stylesheet
  # once, even if it is @included multiple times.
  if [ $QUIET ]; then
    (node-sass ${STYLESHEETS[@]} --output $CSSDIR --precision 3 --source-map --watch &) &> /dev/null
  else
    node-sass ${STYLESHEETS[@]} --output $CSSDIR --precision 3 --source-map --watch
  fi
else
  # Iterating through stylesheets so that shell output is immediate.
  for ss in ${STYLESHEETS[@]}; do
    node-sass $ss --output $CSSDIR --precision 3 --source-map
  done
fi
